package com.tencent.angel.spark.ml.psf.ftrl;

import com.tencent.angel.ml.matrix.MatrixContext;
import com.tencent.angel.ml.matrix.PartitionMeta;
import com.tencent.angel.ps.storage.partitioner.ColumnRangePartitioner;
import com.tencent.angel.ps.storage.partitioner.RangePartitioner;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.util.ArrayList;
import java.util.List;

public class PCGFTRLPartitioner extends ColumnRangePartitioner {

  private static final Log LOG = LogFactory.getLog(RangePartitioner.class);
  long start, end;

//  private static final long[] starts = {0L,193514046488576L,281474976710656L,545357767376896L,897201488265216L,1073123348709376L,1143492092887040L,1671257674219520L,2093470139285504L,2146246697418752L,2216615441596416L,2286984185774080L,3166593487994880L,3360107534483456L,3940649673949184L,4169348092526592L,4274901208793088L,4292493394837504L,4327677766926336L,4450823069237248L,4503599627370496L,6069304185323520L,6597069766656000L,6632254138744832L,6667438510833664L,7142427534032896L,7230388464254976L,7793338417676288L,8268327440875520L,8321103999008768L,8356288371097600L,8532210231541760L,8549802417586176L,8567394603630592L,8584986789675008L,8620171161763840L,8813685208252416L,8866461766385664L,8901646138474496L,8936830510563328L,9024791440785408L,11646027161403392L,12402491161313280L,13088586417045504L,13246916091445248L,13282100463534080L,13317284835622912L,13352469207711744L,13581167626289152L,14460776928509952L,14601514416865280L,14882989393575936L,15410754974908416L,15674637765574656L,16378325207351296L,16554247067795456L,16624615811973120L,16659800184061952L,16694984556150784L,16730168928239616L,17029236090994688L,17046828277039104L,17064420463083520L,17082012649127936L,17099604835172352L,17117197021216768L,17134789207261184L,17152381393305600L,17169973579350016L,17205157951438848L,17240342323527680L,17398671997927424L,17627370416504832L,17697739160682496L,17750515718815744L,17785700090904576L,17820884462993408L,17856068835082240L,17891253207171072L,18049582881570816L,19193074974457856L,23890188648316928L,24400362043604992L,25104049485381632L,25754960369025024L,26317910322446336L,26476239996846080L,26511424368934912L,26529016554979328L,26564200927068160L,26599385299156992L,26616977485201408L,26652161857290240L,26687346229379072L,26722530601467904L,27391033671155712L,29343766322085888L,29660425670885376L,29924308461551616L,30487258414972928L,30909470880038912L,31120577112571904L,31243722414882816L,31630750507859968L,32703873856569344L,33002941019324416L,33090901949546496L,33196455065812992L,33249231623946240L,33284415996035072L,33319600368123904L,33354784740212736L,33389969112301568L,33425153484390400L,33460337856479232L,33495522228568064L,34076064368033792L,34093656554078208L,34111248740122624L,34128840926167040L,34146433112211456L,34164025298255872L,34181617484300288L,34199209670344704L,34216801856389120L,34234394042433536L,34251986228477952L,34269578414522368L,34287170600566784L,34304762786611200L,34322354972655616L,34339947158700032L,34375131530788864L,34410315902877696L,34445500274966528L,34480684647055360L,34586237763321856L,35026042414432256L,35272333019054080L,35342701763231744L,35395478321364992L,35448254879498240L,35483439251587072L,35518623623675904L,35553807995764736L,35588992367853568L,35624176739942400L,35659361112031232L,35694545484120064L,35729729856208896L,35764914228297728L,35976020460830720L,36081573577097216L,36116757949186048L,38386149948915712L,50208098970763264L,51228445761339392L,52336753482137600L,52794150319292416L,53110809668091904L,58757901388349440L,59496773202214912L,59672695062659072L,62258746411188224L,62434668271632384L,63015210411098112L,65302194596872192L,65460524271271936L,66604016364158976L,68697486503444480L,68732670875533312L,68767855247622144L,68803039619710976L,68838223991799808L,68873408363888640L,68908592735977472L,68943777108066304L,68978961480155136L,69084514596421632L,69190067712688128L,69911347340509184L,70667811340419072L,70773364456685568L,70861325386907648L,71230761293840384L,71336314410106880L,71441867526373376L,72075186223972352L,72180739340238848L,72233515898372096L,74661237572501504L,76719523339698176L,76772299897831424L,76913037386186752L,144132780261900288L,144167964633989120L,144343886494433280L,144361478680477696L,144379070866522112L,144467031796744192L,144994797378076672L,146877161284829184L,148284536168382464L,153403862307307520L,153421454493351936L,153439046679396352L,153456638865440768L,153544599795662848L,153720521656107008L,153878851330506752L,164416570771111936L,288265560523800576L,288300744895889408L,288335929267978240L,288371113640067072L,288670180802822144L,288687772988866560L,288705365174910976L,288722957360955392L,288740549546999808L,288758141733044224L,288775733919088640L,288934063593488384L,289321091686465536L,289901633825931264L,290165516616597504L,297167206662275072L,306543841823948800L,306631802754170880L,306825316800659456L,306842908986703872L,306860501172748288L,306878093358792704L,306895685544837120L,306913277730881536L,306930869916925952L,307089199591325696L,307388266754080768L,307441043312214016L,307493819870347264L,307757702661013504L,327372990100537344L,331014572611731456L,576478344489467904L,576513528861556736L,576548713233645568L,576583897605734400L,576619081977823232L,576654266349912064L,576689450722000896L,576724635094089728L,576953333512667136L,577322769419599872L,577340361605644288L,577357953791688704L,577375545977733120L,577393138163777536L,577410730349821952L,577428322535866368L,577445914721910784L,577463506907955200L,577481099093999616L,577498691280044032L,577516283466088448L,577533875652132864L,577551467838177280L,577569060024221696L,577868127186976768L,578483853698531328L,578642183372931072L,579627345791418368L,579908820768129024L,580225480116928512L,580366217605283840L,595266799184904192L,613017314903719936L,613140460206030848L,613228421136252928L,613316382066475008L,613633041415274496L,613650633601318912L,613668225787363328L,613685817973407744L,613703410159452160L,613721002345496576L,613738594531540992L,613756186717585408L,613773778903629824L,613791371089674240L,613808963275718656L,613826555461763072L,613844147647807488L,613861739833851904L,613879332019896320L,614178399182651392L,614354321043095552L,614758941322117120L,614811717880250368L,614864494438383616L,614917270996516864L,614970047554650112L,615304299089494016L,615480220949938176L,616482975554469888L};

  private static final long[] starts = {0L,133109626437632L,227598906949632L,261408889503744L,280375465082880L,520412597321728L,534981126389760L,557108797898752L,833704691761152L,1042749339992064L,1067144754233344L,1070786886500352L,1077315236790272L,1116210460622848L,1653115732361216L,1660125118988288L,1668027858812928L,1963521608777728L,2085910996844544L,2130509937246208L,2134152069513216L,2137794201780224L,2141367614570496L,2145078466314240L,2154767912534016L,2217714953224192L,2232008604385280L,2401333395062784L,3289807509782528L,3321212310650880L,3337773704544256L,3647080069332992L,3896394330931200L,4141654143401984L,4166118277120000L,4181236562001920L,4259233168097280L,4262600422457344L,4266242554724352L,4270022125944832L,4273664258211840L,4277237671002112L,4280673644838912L,4284315777105920L,4287957909372928L,4291462602686464L,4302114121580544L,4335717945704448L,4424984545984512L,4443470085226496L,4457488858480640L,4479891407896576L,4794076855533568L,6081398813229056L,6418605285572608L,6617548170723328L,6627924811710464L,6645654436708352L,6657955223044096L,6666751316066304L,6684549660540928L,7177886784028672L,7436546894462976L,7787634701107200L,8191224187977728L,8282689811513344L,8310864796975104L,8325227167612928L,8342888073134080L,8360480259178496L,8514686764974080L,8518260177764352L,8521833590554624L,8525407003344896L,8529049135611904L,8532622548402176L,8536195961192448L,8539838093459456L,8543480225726464L,8547053638516736L,8550627051307008L,8554131744620544L,8557773876887552L,8561347289677824L,8564851982991360L,8568494115258368L,8572067528048640L,8575778379792384L,8579351792582656L,8582993924849664L,8589934592000000L,8601960500428800L,8615704395776000L,8651850840539136L,8814097525112832L,8848938299817984L,8871890605047808L,8886184256208896L,8900340468416512L,8912435096322048L,8924048687890432L,8935799718412288L,9020599552704512L,9062655872466944L,9607807481413632L,11647264111984640L,12182107799420928L,12588583504314368L,13018629989728256L,13222658116157440L,13241212374876160L,13259010719350784L,13273441809465344L,13285811315277824L,13294469969346560L,13306908194635776L,13319896175738880L,13338794031841280L,13354943108874240L,13470529268744192L,13748430832664576L,14435900477931520L,14573545589833728L,14838802770034688L,14912744927002624L,15387390352818176L,15587982505410560L,15709272381849600L,16325548649218048L,16481748019838976L,16538647746576384L,16583727723315200L,16614926365753344L,16629494894821376L,16642689034354688L,16656913966039040L,16670589141909504L,16686051024175104L,16700825711673344L,16718417897717760L,16733811060506624L,16756625926782976L,17031572553203712L,17035283404947456L,17038994256691200L,17042567669481472L,17046141082271744L,17049714495062016L,17053287907852288L,17056792601165824L,17060503452909568L,17064145585176576L,17067787717443584L,17071429849710592L,17074934543024128L,17078576675291136L,17082081368604672L,17085792220348416L,17089434352615424L,17093007765405696L,17096512458719232L,17100154590986240L,17103796723253248L,17107507574996992L,17111149707264000L,17114654400577536L,17118159093891072L,17121732506681344L,17125305919471616L,17129016771215360L,17132796342435840L,17136507194179584L,17140286765400064L,17143860178190336L,17147364871503872L,17151007003770880L,17154305538654208L,17157878951444480L,17161452364234752L,17165094496501760L,17168599189815296L,17176364490686464L,17188321679638528L,17200141429637120L,17212648374403072L,17224880441262080L,17237181227597824L,17278206755209216L,17454540932513792L,17600226223194112L,17653071500804096L,17683857826381824L,17710589702832128L,17735672311840768L,17751477791490048L,17765359125790720L,17780133813288960L,17796557768228864L,17809614468808704L,17821640377237504L,17833666285666304L,17846310669385728L,17857992980430848L,17869606571999232L,17954543845244928L,18022438688260096L,18044978676629504L,18049582881570816L,19178643884343296L,19211766672130048L,23675783880900608L,24268832965132288L,24380502114828288L,24715234686009344L,25224583447576576L,25586666370498560L,25925934427144192L,26301829964890112L,26409101068075008L,26470604999753728L,26481806274461696L,26496718400913408L,26519808145096704L,26522075887828992L,26530940700327936L,26539255757012992L,26550319592767488L,26564063488114688L,26576158116020224L,26593681582587904L,26608250111655936L,26613129194504192L,26623437116014592L,26638005645082624L,26652986491011072L,26666661666881536L,26678000380542976L,26690163727925248L,26703976342749184L,26718063835480064L,26731189255536640L,27434120783069184L,27997895370211328L,29354486560456704L,29677811698499584L,29802331390345216L,29913931820564480L,30225437208608768L,30480386467299328L,30787562528309248L,31056736718684160L,31159266177974272L,31235407358197760L,31440809874161664L,31629857154662400L,31887761350852608L,32752595965575168L,32975659387060224L,33027817469902848L,33078395004780544L,33136669121052672L,33198791528022016L,33224149014937600L,33239954494586880L,33252736317259776L,33268473077432320L,33281048741675008L,33295136234405888L,33311628908822528L,33327503107948544L,33340078772191232L,33353066753294336L,33367566562885632L,33380210946605056L,33395260512010240L,33410310077415424L,33425497081774080L,33441783597760512L,33457451638456320L,33471195533803520L,33486313818685440L,33731161314295808L,34061083522105344L,34064588215418880L,34068299067162624L,34071803760476160L,34075652051173376L,34079156744486912L,34082798876753920L,34086372289544192L,34090083141287936L,34093793993031680L,34097367405821952L,34100940818612224L,34104582950879232L,34108293802622976L,34111935934889984L,34115578067156992L,34119220199424000L,34122862331691008L,34126573183434752L,34130215315701760L,34133857447968768L,34137362141282304L,34140935554072576L,34144646405816320L,34148151099129856L,34151793231396864L,34155504083140608L,34159214934884352L,34162925786628096L,34166361760464896L,34169866453778432L,34173439866568704L,34176807120928768L,34180311814242304L,34183953946509312L,34187596078776320L,34191169491566592L,34194742904356864L,34198247597670400L,34201958449414144L,34205600581681152L,34209242713948160L,34212953565691904L,34216458259005440L,34220031671795712L,34223673804062720L,34227384655806464L,34231026788073472L,34234531481387008L,34238242333130752L,34241747026444288L,34245320439234560L,34248893852024832L,34252329825861632L,34256040677605376L,34259614090395648L,34263256222662656L,34266898354929664L,34270540487196672L,34274182619463680L,34277962190684160L,34281604322951168L,34285177735741440L,34288888587485184L,34292324561321984L,34295966693588992L,34299608825856000L,34303182238646272L,34306893090390016L,34310603942133760L,34314314793877504L,34318025645621248L,34321599058411520L,34325309910155264L,34328952042422272L,34332731613642752L,34336305026433024L,34340153317130240L,34354240809861120L,34366747754627072L,34379254699393024L,34392311399972864L,34406192734273536L,34418218642702336L,34431550221189120L,34444194604908544L,34457663622348800L,34470033128161280L,34488449947926528L,34543769126699008L,34599157024948224L,34979450609205248L,35212203476910080L,35264430279229440L,35312533912944640L,35343663835906048L,35372457296658432L,35399395331538944L,35430181657116672L,35457669447811072L,35476154987053056L,35491410710888448L,35506528995770368L,35521097524838400L,35535940931813376L,35552090008846336L,35567345732681728L,35582670175993856L,35597032546631680L,35610776441978880L,35622458753024000L,35634278503022592L,35646510569881600L,35658605197787136L,35670974703599616L,35682244697784320L,35694133167259648L,35705815478304768L,35717703947780096L,35729592417255424L,35741755764637696L,35813911215210496L,35945096696299520L,36034638174486528L,36082260771864576L,36086864976805888L,36091469181747200L,36096073386688512L,36226846550917120L,38351858930024448L,38358455999791104L,38365190508511232L,38430474011410432L,50142403151003648L,50601243097169920L,51338053326733312L,52159594671112192L,52689490556223488L,52791057942839296L,52897366973349888L,53250653803249664L,54000864330776576L,59391220085948416L,59500415334481920L,59604800219643904L,60347657763160064L,62228990877761536L,62329115155365888L,62439135037620224L,62749197316653056L,63659180627591168L,65302194596872192L,65399982412267520L,65496533277081600L,66512619460100096L,68680787670597632L,68692744859549696L,68704976926408704L,68715903323209728L,68728135390068736L,68739336664776704L,68751843609542656L,68765518785413120L,68778712924946432L,68792181942386688L,68804345289768960L,68816577356627968L,68828397106626560L,68841041490345984L,68853342276681728L,68866330257784832L,68880280311562240L,68890519513595904L,68903507494699008L,68916289317371904L,68929139859521536L,68939791378415616L,68953191676379136L,68980198430736384L,69035998645846016L,69091867580432384L,69147186759204864L,69202437218500608L,69839123170459648L,69972782552711168L,70655991590420480L,70711379488669696L,70766286350581760L,70821261931970560L,70875756477022208L,70930594619457536L,71266495421743104L,71321745881038848L,71378164571439104L,71433964786548736L,71489146526367744L,72071200494321664L,72086387498680320L,72165071299543040L,72169538065530880L,72174142270472192L,72178815194890240L,72183350680354816L,72187886165819392L,72192490370760704L,72197025856225280L,72462695353286656L,74812214262890496L,76703924018479104L,76710589807722496L,76717255596965888L,76723646508302336L,76730243578068992L,76736978086789120L,76855038147821568L,76932484998103040L,144116631184867328L,144131680750272512L,144146867754631168L,144162054758989824L,144177104324395008L,144326912783679488L,144331448269144064L,144335983754608640L,144340587959549952L,144345192164491264L,144349796369432576L,144354331854897152L,144358867340361728L,144363471545303040L,144368075750244352L,144372679955185664L,144377215440650240L,144381819645591552L,144386423850532864L,144391028055474176L,144395632260415488L,144670853764743168L,145038365526327296L,146870289337155584L,147151764313866240L,148282955620417536L,153281404199763968L,153404205904691200L,153410802974457856L,153417537483177984L,153424409430851584L,153431143939571712L,153437947167768576L,153444681676488704L,153451278746255360L,153458013254975488L,153464679044218880L,153471344833462272L,153606103727341568L,153705746968608768L,153733578356686848L,153848958358126592L,154133388272336896L,288230925907525632L,288246112911884288L,288261299916242944L,288276280762171392L,288291467766530048L,288306586051411968L,288321773055770624L,288336960060129280L,288351940906057728L,288366853032509440L,288653000933638144L,288657742577532928L,288662346782474240L,288666882267938816L,288671417753403392L,288676021958344704L,288680557443809280L,288685230368227328L,288689834573168640L,288694370058633216L,288698905544097792L,288703509749039104L,288708113953980416L,288712649439444992L,288717253644386304L,288721857849327616L,288726530773745664L,288731134978686976L,288735739183628288L,288740205949616128L,288744810154557440L,288749345640022016L,288753949844963328L,288758554049904640L,288763226974322688L,288767762459787264L,288772366664728576L,288776902150193152L,288781437635657728L,288785973121122304L,288790508606586880L,289057346334752768L,289285838594899968L,289778694682050560L,289911941747441664L,290113221094801408L,290199120440721408L,297071342992228352L,298726863906275328L,306551469685866496L,306606307828301824L,306661352129167360L,306813840648044544L,306820506437287936L,306827240946008064L,306834044174204928L,306840709963448320L,306847307033214976L,306854041541935104L,306860776050655232L,306867716717805568L,306874382507048960L,306881117015769088L,306887851524489216L,306894586033209344L,306901251822452736L,306907986331172864L,306914514681462784L,306921180470706176L,306927983698903040L,306934718207623168L,306941315277389824L,306948049786109952L,307183139116023808L,307385174377627648L,307412868326752256L,307440837153783808L,307468943419768832L,307497049685753856L,307704101469159424L,307872326748209152L,325345284500488192L,328833004103270400L,331084803916955648L,576464875472027648L,576479993756909568L,576495180761268224L,576510230326673408L,576525279892078592L,576540398176960512L,576555379022888960L,576570359868817408L,576585546873176064L,576600596438581248L,576615371126079488L,576630351972007936L,576645401537413120L,576660588541771776L,576675706826653696L,576690756392058880L,576705874676940800L,576720992961822720L,576736042527227904L,577007896777195520L,577306757781520384L,577311293266984960L,577315966191403008L,577320501676867584L,577325105881808896L,577329710086750208L,577334245572214784L,577338849777156096L,577343453982097408L,577348058187038720L,577352662391980032L,577357197877444608L,577361870801862656L,577366475006803968L,577371147931222016L,577375752136163328L,577380356341104640L,577384960546045952L,577389564750987264L,577394168955928576L,577398773160869888L,577403377365811200L,577408050290229248L,577412585775693824L,577417189980635136L,577421656746622976L,577426123512610816L,577430727717552128L,577435331922493440L,577439936127434752L,577444471612899328L,577449144537317376L,577453748742258688L,577458352947200000L,577462957152141312L,577467561357082624L,577472165562023936L,577476838486441984L,577481373971906560L,577485978176847872L,577490513662312448L,577495117867253760L,577499653352718336L,577504257557659648L,577508861762600960L,577513465967542272L,577518070172483584L,577522674377424896L,577527278582366208L,577531882787307520L,577536486992248832L,577541022477713408L,577545626682654720L,577550162168119296L,577554835092537344L,577559508016955392L,577564112221896704L,577568716426838016L,577573389351256064L,577578062275674112L,577582666480615424L,577938702089584640L,578389158259589120L,578520824777015296L,578614351984852992L,579312541868490752L,579617725064675328L,579757019444019200L,580046534599507968L,580191670134374400L,580277569480294400L,580363468826214400L,580631268627054592L,597400264059650048L,598690884552228864L,613016558989475840L,613106993820860416L,613162038121725952L,613217013703114752L,613271989284503552L,613326827426938880L,613621290384752640L,613628024893472768L,613634759402192896L,613641493910913024L,613648228419633152L,613654825489399808L,613661491278643200L,613668088348409856L,613674822857129984L,613681557365850112L,613688291874570240L,613694820224860160L,613701417294626816L,613708083083870208L,613714886312067072L,613721483381833728L,613728217890553856L,613734952399273984L,613741618188517376L,613748352697237504L,613755018486480896L,613761546836770816L,613768281345490944L,613774878415257600L,613781612923977728L,613788209993744384L,613794807063511040L,613801541572231168L,613808276080951296L,613815010589671424L,613821676378914816L,613828342168158208L,613834939237924864L,613841536307691520L,613848408255365120L,613855005325131776L,613861464955944960L,613868199464665088L,613874933973385216L,613881599762628608L,613888402990825472L,613895137499545600L,614260037921013760L,614365247439896576L,614743548159328256L,614771310827929600L,614799348374437888L,614827454640422912L,614855492186931200L,614883598452916224L,614911498560471040L,614939604826456064L,614967504934010880L,614995473761042432L,615306429393272832L,615413356899074048L,615520765441212416L,615810280596701184L};

  @Override
  public List<PartitionMeta> getPartitions() {

    start = mContext.getMaxColNumInBlock();
    end = mContext.getColNum();

    int row = mContext.getRowNum();

    List<PartitionMeta> partitions = new ArrayList<>();

    int matrixId = mContext.getMatrixId();


    for (int i = 0; i < starts.length - 1; i++) {
      PartitionMeta meta = new PartitionMeta(matrixId, i, 0, row, start, starts[i+1]);
      partitions.add(meta);
      start = starts[i+1];
    }

    partitions.add(new PartitionMeta(matrixId, starts.length - 1, 0, row, start, end));

    LOG.info("partition count: " + partitions.size());
    return partitions;
  }

  @Override
  protected long getMaxIndex(MatrixContext mContext) {
    return end;
  }

  @Override
  protected long getMinIndex(MatrixContext mContext) {
    return start;
  }

}
